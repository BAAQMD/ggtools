---
title: "Charting Annual Data"
date: "`r Sys.Date()`"
output: 
  html_vignette:
    df_print: tibble
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Charting Annual Data}
  \usepackage[utf8]{inputenc}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r options, include = FALSE, message = FALSE}
library(knitr)
opts_chunk$set(
  fig.width = 8,
  fig.height = 4,
  out.width = 700,
  out.height = 700 / (8 / 4),
  dpi = 300)
```

## Motivation

After working through the material in this vignette, you will understand how to chart:

- annual emission estimates, like those in `BY` or `RY` data;
- annual growth factors, normalized to any year;
- annual throughputs;
- annual emission factors; and
- annualized control factors.

To demonstrate, we'll use some data from the `BY2011` package. It's important to note that these techniques will work in **exactly the same way with RY or PY data**.

## Setup

Our first step is to load the `inventory` and `BY2011` packages.

```{r libraries, message = FALSE}
library(inventory)
library(BY2011)
```

```{r ggtools, message = FALSE, include = FALSE}
library(ggtools) # FIXME: put `ggtools` back in the `Depends` of the `inventory` package
```

Wait for it --- `inventory` imports a lot of stuff! You will see a lot of red message text scroll by.

## Loading BY2011 data

`BY2011_annual_emission_data` is *tabular data* supplied by the `BY2011`
package. Since we invoked `library(BY2011)`, we have access to it. **Here is what it looks like.**

```{r BY2011_annual_emission_data-show}
show(BY2011_annual_emission_data)
```

## Charting annual emissions

The `chart_annual_emissions_by()` function --- and its slightly simplified cousin, `chart_annual_emissions()` --- will be the foundation of this section. To learn more about `chart_annual_emissions_by()`, you can always type `help("chart_annual_emissions_by")`.

This section will show you how to create charts showing annual emissions for:
    
- single and multiple pollutants; and
- single and multiple categories

... and how to customize those charts with:
    
- a unique color for each category;
- directly labeled values at specific years;
- reader-friendly names for categories; and
- stacked (area) aesthetics, instead of the default (lines).

**Before continuing,** it's probably best if you have already worked through the material in the *Introduction to BY Data* vignette. To view that vignette, just type `vignette("BY2011-introduction")`. 

Let's try it out on a relatively simple case: charting NOx emissions from category `#283`, natural gas consumed for residential water heating.

```{r BY2011_annual_emission_data-283-NOx, message = FALSE}
#
# Note: Because there is only one distinct `cat_id` in these data, it is fine to use
# the shorthand `chart_annual_emissions()` instead of `chart_annual_emissions_by(cat_id)`.
#
BY2011_annual_emission_data %>%
  filter_categories(
    283) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_emissions()
```

### Using color

If you want to chart more than one category, you will probably want a way to distinguish them. Just use the `color` parameter.

```{r BY2011_annual_emission_data-283-284-NOx, message = FALSE}
BY2011_annual_emission_data %>%
  filter_categories(
    283, 
    284) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_emissions_by(
    color = cat_id)
```

The default color scheme is provided by `scale_color_few("Dark")`. This supplies up to nine distinct colors. You can try using a different color scheme if you like. Go to the "Help" pane in RStudio, and type "scale_color_" --- then wait. You should see a list of choices pop up.

### Flagging values

You can choose to "flag" values for specific years:

```{r BY2011_annual_emission_data-283-284-NOx-flag_years, message = FALSE}
BY2011_annual_emission_data %>%
  filter_categories(
    283, 
    284) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_emissions_by(
    color = cat_id,
    flag_years = CY(1993, 2011))
```

### Humanizing category names

You can also, in the process of filtering, supply more human-readable names for the categories.

```{r BY2011_annual_emission_data-283-284-NOx-humanize_category_names, message = FALSE}
BY2011_annual_emission_data %>%
  filter_categories(
    "#283 Space Heating" = 283, 
    "#284 Water Heating" = 284) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_emissions_by(
    color = category,
    flag_years = CY(1993, 2011))
```

### Titling and captioning

Last but not least, you can provide a `title`, `subtitle`, and/or `caption`. This is strongly encouraged!

```{r}
BY2011_annual_emission_data %>%
  filter_categories(
    "#283 Space Heating" = 283, 
    "#284 Water Heating" = 284) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_emissions_by(
    color = category,
    flag_years = CY(1993, 2011),
    title = "Residential NG Combustion: Water and Space Heating",
    subtitle = "Between CY1993-2002, controls on NOx from water heating were strengthened.")
```

### Making an area chart

Stacking, via `geom = "area"`, can be a good way to show how the total and the proportions vary over time. (Compare with the line-charts above, which are not stacked.)

```{r BY2011_annual_emission_data-283-284-NOx-area, message = FALSE}
BY2011_annual_emission_data %>%
  filter_categories(
    "#283 Space Heating" = 283, 
    "#284 Water Heating" = 284) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_emissions_by(
    color = category,
    geom = "area",
    title = "Residential NG Combustion: Water and Space Heating",
    subtitle = "Combined emissions from water and space heating have declined, but are projected to rise reach 1990 levels by 2030.")
```

### Showing multiple pollutants

You may wish to show more than one pollutant at the same time. You can definitely do that!

```{r message = FALSE}
BY2011_annual_emission_data %>%
  filter_categories(
    "#283 Space Heating" = 283, 
    "#284 Water Heating" = 284) %>%
  filter_pollutants(
    "NOx",
    "PM10") %>%
  chart_annual_emissions_by(
    color = category,
    title = "Residential NG Combustion: Water and Space Heating",
    subtitle = "Between CY1993-2002, controls on NOx from water heating were strengthened.")
```

## Charting annual growth

What if we want to view the above in terms of annual growth, relative to a given `base_year`? 

We can do that with the closely related `chart_annual_growth_by()`. This expects exactly the same input as `chart_annual_emissions()`. The only difference is that you have to supply a `base_year`.

The base year can be `CY`, `BY`, `RY` or `PY`. It doesn't even have to be prefixed, although prefixing is very strongly encouraged.

Here is a simple example:

```{r BY2011_annual_emission_data-283-NOx-chart_annual_growth_by, message = FALSE}
#
# Note how similar this is to the very first example. The only difference is the use
# of `chart_annual_growth_by()` in place of `chart_annual_emissions_by()`, and the
# provision of a `base_year`.
#
BY2011_annual_emission_data %>%
  filter_categories(
    283) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_growth_by(
    cat_id,
    base_year = BY(2011)) # required; can be BY or CY
```

We can enhance it in exactly the same way, too:

```{r}
BY2011_annual_emission_data %>%
  filter_categories(
    "#283 Space Heating" = 283, 
    "#284 Water Heating" = 284) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_growth_by(
    color = category,
    base_year = BY(2011),
    flag_years = CY(1993, 2002, 2030),
    title = "Residential NG Combustion: Water and Space Heating",
    subtitle = str_c(
      "Between CY1993-2002, controls on NOx from water heating in the Bay Area reduced those emissions by nearly half.",
      "Emissions from both water and space heating are projected to grow by approximately +24% from CY2011 to CY2030.",
      "Labeled values are percent changes relative to the base year (CY2011).",
      sep = "\n")) # combine lines with a newline
```

You can use this technique with data that have already been "normalized", like growth profiles. There's no difference in the output.

## Charting throughputs

TODO: showcase `chart_annual_throughputs_by()`.

## Charting emission factors

TODO: showcase `chart_annual_quantities_by()`, using emission factors for some category where they vary over time.

## Charting control factors

TODO: showcase `chart_annual_quantities_by()`, using control factors for some category where they vary over time.

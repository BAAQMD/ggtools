---
title: "Charting Annual Data"
date: "`r Sys.Date()`"
output: 
  html_vignette:
    df_print: kable
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Charting Annual Data}
  \usepackage[utf8]{inputenc}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r options, include = FALSE, message = FALSE}
library(knitr)
opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  fig.width = 8,
  fig.height = 4,
  out.width = 700,
  out.height = 700 / (8 / 4),
  dpi = 300)
```

## Motivation

After working through the material in this vignette, you will understand how to chart:

- annual emission estimates, like those in `BY` or `RY` data;
- annual growth factors, normalized to any year;
- annual throughputs;
- annual emission factors; and
- annualized control factors.

To demonstrate, we'll use some data from the `BY2011` package. It's important to note that these techniques will work in **exactly the same way with RY or PY data**.

## Setup

Our first step is to load the `inventory` and `BY2011` packages.

```{r libraries, message = FALSE}
library(inventory)
library(BY2011)
```

```{r ggtools, message = FALSE, include = FALSE}
library(ggtools) # FIXME: put `ggtools` back in the `Depends` of the `inventory` package
```

Wait for it --- `inventory` imports a lot of stuff! You will see a lot of red message text scroll by.

## Loading BY2011 data

`BY2011_annual_emission_data` is *tabular data* supplied by the `BY2011`
package. Since we invoked `library(BY2011)`, we have access to it. **Here is what it looks like.**

```{r BY2011_annual_emission_data-head}
head(BY2011_annual_emission_data)
```

## Charting annual emissions

The `chart_annual_emissions_by()` function --- and its slightly simplified cousin, `chart_annual_emissions()` --- will be the foundation of this section. To learn more about `chart_annual_emissions_by()`, you can always type `help("chart_annual_emissions_by")`.

This section will show you how to create charts showing annual emissions for:
    
- single and multiple pollutants; and
- single and multiple categories

... and how to customize those charts with:
    
- a unique color for each category;
- directly labeled values at specific years;
- reader-friendly names for categories; and
- stacked (area) aesthetics, instead of the default (lines).

**Before continuing,** it's probably best if you have already worked through the material in the *Introduction to BY Data* vignette. To view that vignette, just type `vignette("BY2011-introduction")`. 

Let's try it out on a relatively simple case: charting NOx emissions from category `#283`, natural gas consumed for residential water heating.

```{r BY2011_annual_emission_data-283-NOx, message = FALSE}
BY2011_annual_emission_data %>%
  filter_categories(
    283) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_emissions()
```

### Using color

If you want to chart more than one category, you will probably want a way to distinguish them. Just use the `color` parameter.

```{r BY2011_annual_emission_data-283-284-NOx, message = FALSE}
BY2011_annual_emission_data %>%
  filter_categories(
    283, 
    284) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_emissions_by(
    color = cat_id)
```

The default color scheme is provided by `scale_color_tableau()`. This supplies up to ten distinct colors. You can try using a different color scheme if you like. Go to the "Help" pane in RStudio, and type "scale_color_" --- then wait. You should see a list of choices pop up.

### Flagging values

You can choose to "flag" values for specific years:

```{r BY2011_annual_emission_data-283-284-NOx-flag_years, message = FALSE}
BY2011_annual_emission_data %>%
  filter_categories(
    283, 
    284) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_emissions_by(
    color = cat_id,
    flag_years = CY(1993, 2011, 2030))
```

### Humanizing category names

You can also, in the process of filtering, supply more human-readable names for the categories.

```{r BY2011_annual_emission_data-283-284-NOx-humanize_category_names, message = FALSE}
BY2011_annual_emission_data %>%
  filter_categories(
    "#283 Space Heating" = 283, 
    "#284 Water Heating" = 284) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_emissions_by(
    color = category,
    flag_years = CY(1993, 2011, 2030))
```

### Titling and captioning

Last but not least, you can provide a `title`, `subtitle`, and/or `caption`. This is strongly encouraged!

```{r}
BY2011_annual_emission_data %>%
  filter_categories(
    "#283 Space Heating" = 283, 
    "#284 Water Heating" = 284) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_emissions_by(
    color = category,
    flag_years = CY(1993, 2011, 2030),
    title = "Residential NG Combustion: Space and Water Heating",
    subtitle = "Between CY1993-2002, controls on NOx from water heating were strengthened.")
```

### Making an area chart

Stacking, via `geom = "area"`, can be a good way to show how the total and the proportions vary over time. (Compare with the line-charts above, which are not stacked.)

```{r BY2011_annual_emission_data-283-284-NOx-area, message = FALSE}
BY2011_annual_emission_data %>%
  filter_categories(
    "#283 Space Heating" = 283, 
    "#284 Water Heating" = 284) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_emissions_by(
    color = category,
    geom = "area",
    title = "Residential NG Combustion: Space and Water Heating",
    subtitle = "Combined emissions from water and space heating have declined, but are projected to rise reach 1990 levels by 2030.")
```

### Showing multiple pollutants

You may wish to show more than one pollutant at the same time. You can definitely do that!

```{r message = FALSE}
BY2011_annual_emission_data %>%
  filter_categories(
    "#283 Space Heating" = 283, 
    "#284 Water Heating" = 284) %>%
  filter_pollutants(
    "NOx",
    "PM10") %>%
  chart_annual_emissions_by(
    color = category,
    title = "Residential NG Combustion: Space and Water Heating",
    subtitle = "Between CY1993-2002, controls on NOx from water heating were strengthened.")
```

***

# Charting annual growth

## Charting relative changes in emissions

What if we want to view the above in terms of annual growth, relative to a given `base_year`? 

We can do that with the closely related `chart_annual_growth_by()`. This expects exactly the same input as `chart_annual_emissions()`. The only difference is that you have to supply a `base_year`.

The base year can be `CY`, `BY`, `RY` or `PY`. It doesn't even have to be prefixed, although prefixing is very strongly encouraged.

Here is a simple example:

```{r BY2011_annual_emission_data-283-NOx-chart_annual_growth_by, message = FALSE}
#
# Note how similar this is to the very first example. The only difference is the use
# of `chart_annual_growth()` in place of `chart_annual_emissions()`, and the
# provision of an explicit `base_year`.
#
BY2011_annual_emission_data %>%
  filter_categories(
    283) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_growth(
    base_year = CY(2011)) # required; can be BY or CY
```

We can enhance it in exactly the same way, too:

```{r}
BY2011_annual_emission_data %>%
  filter_categories(
    "#283 Space Heating" = 283, 
    "#284 Water Heating" = 284) %>%
  filter_pollutants(
    "NOx") %>%
  chart_annual_growth_by(
    color = category,
    base_year = BY(2011),
    flag_years = CY(1993, 2002, 2030),
    title = "Residential NG Combustion: Space and Water Heating",
    subtitle = str_c(
      "Between CY1993-2002, controls on NOx from water heating in the Bay Area reduced those emissions by nearly half.",
      "Emissions from both water and space heating are projected to grow by approximately +24% from CY2011 to CY2030.",
      "Labeled values are percent changes relative to the base year (CY2011).",
      sep = "\n")) # combine lines with a newline
```

## Charting a growth profile

You can use this technique with data that have already been "normalized", like growth profiles. There's no difference in the output. Here's an example where we chart an associated growth profile directly, in both its "normalized" and "raw" forms.

### Charting normalized growth factors

```{r QA_normalized_gf_data, cache = TRUE}
#
# `DB_growth_profiles()` automatically normalizes BY2011 data to CY2011.
#
QA_normalized_gf_data <-
  BY(2011) %>%
  DB_growth_profiles(
    verbose = TRUE) %>%
  filter_categories(
    "#283 Space Heating" = 283) 
```

Here, we are pulling and charting the *normalized* growth profile data that, in the BY2011 inventory, was linked (via `t1325`) to category #283. 

```{r QA_normalized_gf_data-chart_annual_growth}
#
# Chart the relative growth in these *normalized* growth factors. (Yes, that's redundant!)
#
QA_normalized_gf_data %>%
  chart_annual_growth(
    base_year = CY(2011),
    flag_years = CY(1993, 2011, 2030),
    title = "Residential NG Combustion: Space and Water Heating",
    subtitle = str_c(
      "This is the growth profile associated with category #283 in BY2011.",
      "There is a +9% change from CY2011 to CY2030.",
      sep = "\n"))
```

### Charting raw growth factors

What if we wanted to chart the raw (un-normalized) growth factors?

First, we look up the ID of the associated profile.

```{r DB_growth_profile_crosswalk}
#
# Look up the growth profile that, for BY2011, was associated with category #283.
# This turns out to be growth profile #555.
# 
BY(2011) %>%
  DB_growth_profile_crosswalk(
    verbose = TRUE) %>%
  filter_categories(
    "#283 Space Heating" = 283)
```

Then, we let `QA_raw_gf_data` be the associated data.

```{r QA_raw_gf_data, cache = TRUE}
#
# Here, we're pulling data for growth profile #555 from DataBank.
#
# (Note: Results from `DB_raw_growth_profiles()` are in a compact form, which we have to `unnest()`.)
#
QA_raw_gf_data <-
  BY(2011) %>%
  DB_raw_growth_profiles(
    verbose = TRUE) %>%
  filter(
    gpf_id == 555) %>%
  unnest(
    gpf_raw_data)
```

Here, we use `chart_annual_quantities()`, instead of `chart_annual_growth()`. This ensures that the numbers *aren't* normalized. If we knew their units, we could label the y-axis. This could be helpful for QA.

```{r QA_raw_gf_data-chart_annual_quantities}
#
# Chart the *raw* growth factors.
#
QA_raw_gf_data %>%
  chart_annual_quantities(
    base_year = CY(2011),
    flag_years = CY(1993, 2011, 2030),
    flag_labels = "{round(gf_qty, digits = 4)}",
    title = "Residential NG Combustion: Space and Water Heating",
    subtitle = str_c(
      "DataBank growth profile #555, linked to category #283 for BY2011 (via t1325).",
      "These \"raw\" growth factors are left as-is by chart_annual_quantities().",
      sep = "\n"))
```

Just to demonstrate equivalence, here we use `chart_annual_growth()` with `QA_raw_growth_factor_data`. This should look exactly the same as `chart_annual_growth()` with `QA_normalized_growth_factor_data` --- and it does.

```{r QA_raw_gf_data-chart_annual_growth}
#
# Chart the *raw* growth factors.
#
QA_raw_gf_data %>%
  chart_annual_growth(
    base_year = CY(2011),
    flag_years = CY(1993, 2011, 2030),
    title = "Residential NG Combustion: Space and Water Heating",
    subtitle = str_c(
      "DataBank growth profile #555, linked to category #283 for BY2011 (via t1325).",
      "The raw growth factors are automatically normalized by chart_annual_growth().",
      sep = "\n"))
```

***

# Charting emission factors

Much like raw growth factors, emission factors can be handled by `chart_annual_quantities()`, if they vary over time. A good example of this is category #749 "Agricultural Land Preparation". Here, `annualize_DB_emission_factors()` does the work of carrying emission factors forward in time, so that for each year, the "most recent" emission factor is applied.

```{r QA_emission_factor_data}
QA_emission_factor_data <-
  BY(2011) %>%
  DB_area_source_emission_factors(
    verbose = TRUE) %>%
  filter_categories(
    "#749 Agricultural Land Prep" = 749) %>%
  annualize_DB_emission_factors(
    verbose = TRUE)
```

In DataBank, emission factors are preserved in units of "pounds per unit of throughput". Below, we use `scale_y_quantity()` to convey this in the chart. (`scale_y_quantity()` also ensures that the axis begins at zero.)

We can also use color to index the pollutant (which, in this case, is only PM).

```{r QA_emission_factor_data-chart_annual_quantities_by}
QA_emission_factor_data %>%
  chart_annual_quantities_by(
    color = pol_abbr,
    base_year = CY(2011), # mark it visually
    flag_years = CY(2011),
    flag_labels = "{signif(ef_qty, 4)} lb/tput",
    title = "Agricultural Land Preparation",
    subtitle = "Emission factors pulled from DataBank (t1326).") +
  scale_y_quantity(
    "Emission factor (lbs per unit of throughput)")
```

***

# Charting control factors

Just like the above, we can use `chart_annual_quantities()` to chart control factors that change over time. Again, we use color to index the controlled pollutants, which is helpful, because there are three.

With control factors, it's helpful to use `scale_y_percentage()`, with the upper limit set to 100%.

```{r charting-control-factors}
QA_control_factor_data <-
  BY(2011) %>%
  DB_control_factors(
    verbose = TRUE) %>%
  filter_categories(
    "#288 Domestic Wood Stoves" = 288) %>%
  annualize_DB_control_factors(
    verbose = TRUE) 
  
QA_control_factor_data %>%
  chart_annual_quantities_by(
    color = pol_abbr,
    base_year = CY(2011), # mark it visually
    flag_years = CY(2011),
    flag_labels = "{format_percentage(cf_qty, digits = 0)}",
    title = "Domestic Wood Stoves",
    subtitle = "Control factors pulled from DataBank (t1328).") +
  scale_y_percentage(
    "Control factor (% uncontrolled)",
    limits = c(0, 1.00))
```

